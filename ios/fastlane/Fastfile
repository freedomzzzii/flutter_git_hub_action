default_platform(:ios)

fastlane_require 'dotenv'

before_all do
  Dotenv.overload '../../.env'
end

platform:ios do
    desc "Setup Certificate"
    lane:setup do
        if is_ci
            # create keychain
            sh('security create-keychain -p "hugeman123" ~/Library/Keychains/cicd.keychain-db')
            sh('security unlock-keychain -p "hugeman123" ~/Library/Keychains/cicd.keychain-db')
            sh('security list-keychains -d user -s ~/Library/Keychains/cicd.keychain-db $(security list-keychains -d user | sed s/\"//g)')
            # import certificate
            sh('security import ../distribution.p12 -P "hugeman123" -A -t cert -f pkcs12 -k ~/Library/Keychains/cicd.keychain-db')
            sh("security import ../distribution.cer ~/Library/Keychains/cicd.keychain-db")
            # set allow codesign
            sh('security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "hugeman123" ~/Library/Keychains/cicd.keychain-db')
            # copy provisioning profile
            sh('mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles')
            sh('cp ../Distribute_comhugemanflutterstarterkit.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles')
            sh('cp ../AdHoc_comhugemanflutterstarterkit.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles')
        else
            create_keychain(
                name: "cicd.keychain-db",
                unlock: true,
                timeout: 0,
                password: ENV["KEYCHAIN_PASSWORD"],
            )
            import_certificate(
                certificate_path: "distribution.cer",
                keychain_name: "cicd.keychain-db",
                keychain_password: ENV["KEYCHAIN_PASSWORD"]
            )
        end

        sh("echo #{ENV['GITHUB_RUN_NUMBER']}")
        sh("cd ../../; ls -la;export GITHUB_RUN_NUMBER=#{ENV['GITHUB_RUN_NUMBER']}; perl -i -pe 's/^(version:)((\\s+\\d+\\.\\d+\\.\\d+\\+)|(\\s+\\d+\\.\\d+\\.\\d+\\-\\w+\\+))(\\d+)$/$1.$2.$ENV{GITHUB_RUN_NUMBER}/e' pubspec.yaml")
    end
    # branch: all branch
    desc "Test ios in Firebase test lab"
    lane:test_lab do
        Dir.chdir("../") do
            sh("pod install")
        end

        sh('security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "hugeman123" ~/Library/Keychains/cicd.keychain-db')

        sh("flutter build ios --config-only integration_test/main_integration_test.dart")
        sh("flutter build ios integration_test/main_integration_test.dart --release")
        sh("xcodebuild -workspace ../Runner.xcworkspace -scheme Runner -config Flutter/Release.xcconfig -derivedDataPath build/ios_integ -sdk iphoneos build-for-testing")

        sh("cd build/ios_integ/Build/Products/; zip -r ../../../../../ios_tests.zip .")

        sh("gcloud firebase test ios run --type=xctest --test=../ios_tests.zip --device=model=iphone8,version=13.6,locale=en,orientation=portrait --xcode-version=12.5 ")
    end

    # run this lane before deploy to firebase app distribute
    desc "Build file for deploy firebase app distribute"
    lane:build_file_for_app_distribution do
#         Dir.chdir("../") do
#             sh("pod install")
#         end
        cocoapods(
          clean_install: true,
          podfile: "Podfile",
          use_bundle_exec: false
        )

        sh('security unlock-keychain -p "hugeman123" ~/Library/Keychains/cicd.keychain-db')
        sh('security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "hugeman123" ~/Library/Keychains/cicd.keychain-db')

       update_code_signing_settings(
         path: "Runner.xcodeproj",
         targets: "Runner",
         profile_name: "Ad-Hoc com.hugeman.flutterstarterkit",
         bundle_identifier: ENV["APP_BUNDLE_ID"],
         use_automatic_signing: false,
         team_id: ENV["APPLE_TEAM_ID"],
         code_sign_identity:  "Apple Distribution",
        )

#         sh("flutter build ipa --export-options-plist=ios/exportOptions.plist")
#        build_app(
#            workspace: "Runner.xcworkspace",
#            scheme: "Runner",
#            configuration: "Release",
#            clean: true,
# #             xcargs: "-allowProvisioningUpdates",
#            export_method: "ad-hoc",
#            export_team_id: ENV["APPLE_TEAM_ID"],
#            export_options: {
#                provisioningProfiles: {
#                    ENV["APP_BUNDLE_ID"] => "Ad-Hoc com.hugeman.flutterstarterkit",
#                }
#            },
#            skip_package_pkg: true,
# #            skip_build_archive: true,
# #            skip_archive: true
#        )
        sh("xcodebuild -workspace Runner.xcworkspace -scheme Runner -sdk iphoneos -configuration Release archive -archivePath Release.xcarchive")
        sh("xcodebuild -exportArchive -archivePath Release.xcarchive -exportOptionsPlist exportOptions.plist -exportPath .")
    end

    # branches: feature, develop, bugfix, hotfix, release
    desc "Deploy a release version to the Firebase App Distribute for Developer testing"
    lane:app_distribution_group_developer do
        firebase_app_distribution(
            app: ENV["FASTLANE_FIREBASE_APP_DISTRIBUTE_ID_IOS"],
            groups: "developer",
      )
    end

    # branches: feature, develop, bugfix, hotfix, release, master(pre-prod)[tag]
    desc "Deploy a release version to the Firebase App Distribute for QA testing"
    lane:app_distribution_group_qa do
        firebase_app_distribution(
            app: ENV["FASTLANE_FIREBASE_APP_DISTRIBUTE_ID_IOS"],
            groups: "qa",
      )
    end

     # branch: release
    desc "Deploy a release version to the Firebase App Distribute for User testing"
    lane:app_distribution_group_user do
        firebase_app_distribution(
            app: ENV["FASTLANE_FIREBASE_APP_DISTRIBUTE_ID_IOS"],
            groups: "user",
        )
    end

    # tag: master
    desc "Deploy a release version to the App store"
    lane:release do
        Dir.chdir("../") do
            sh("pod install")
        end

        sh('security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "hugeman123" ~/Library/Keychains/cicd.keychain-db')

        update_code_signing_settings(
          path: "Runner.xcodeproj",
          targets: "Runner",
          profile_name: "Distribute com.hugeman.flutterstarterkit",
          bundle_identifier: ENV["APP_BUNDLE_ID"],
          use_automatic_signing: false,
          team_id: ENV["APPLE_TEAM_ID"],
          code_sign_identity:  "Apple Distribution",
         )

        build_app(
          workspace: "Runner.xcworkspace",
          scheme: "Runner",
          configuration: "Release",
          clean: true,
          export_method: "app-store",
          export_team_id: ENV["APPLE_TEAM_ID"],
        )

        upload_to_app_store(
            username: ENV["APPLE_ID"],
            app_identifier: ENV["APP_BUNDLE_ID"],
            team_id: ENV["APPLE_TEAM_ID"],
            force: true,
            ipa: "Runner.ipa"
        )
    end
end
