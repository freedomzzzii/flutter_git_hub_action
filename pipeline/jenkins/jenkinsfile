@Library('jenkins-shared-libraries') _

pipeline {
    // (pipeline) Declarative environment variable,
    environment {
        CI_GITHUB_REPOSITORY_NAME = "${sh(script:"basename $GIT_URL .git", returnStdout: true).trim()}"
        CI_DOCKER_REGISTRY_NAME = credentials('JK_DOCKER_REGISTRY_NAME')
        CI_GITHUB_ACCESS_TOKEN = credentials('JK_GITHUB_ACCESS_TOKEN')
        CI_GITHUB_ORGANIZATION = credentials('JK_GITHUB_ORGANIZATION')
        CI_GITHUB_GITOPS_REPO = credentials('JK_GITHUB_GITOPS_REPO')
        CI_GITHUB_EMAIL = credentials('JK_GITHUB_EMAIL')
        CI_GITHUB_USER = credentials('JK_GITHUB_USER')
        CI_SYNK_TOKEN = credentials('JK_SYNK_TOKEN')
        CI_SONARQUBE_PROJECT_KEY = credentials('JK_SONARQUBE_PROJECT_KEY')
    }
    // this is a YAML representation of the Pod, to allow setting any values not supported as fields.
    // pod available: dind-awscli
    agent {
        kubernetes {
            // declarative agents can be defined from YAML.
            yamlFile "pipeline/jenkins/podTemplate.yaml"
        }
    }
    // to do actions
    stages {
        // checkout source code version
        stage('checkout-scm') {
            steps {
                checkout(scm)
        }
    }
        // prepare environment variable
        stage('preparation-environment-variable') {
            parallel {
                stage('prepare-feature-environment') {
                    when {
                        expression {
                            env.BRANCH_NAME ==~ /feature\/[a-zA-Z]+.\d+.[a-zA-Z]+.*/ // e.g: feature/hcd-456-foo
                        }
                    }
                    steps {
                        script {
                            // (pipeline) Declarative environment variable - build stage
                            env.CI_BRANCH_ENVIRONMENT = "${sh(script:"echo $BRANCH_NAME | cut -d/ -f1", returnStdout: true).trim()}"
                            env.CI_GITHUB_FEATURE_VERSION = "${sh(script:"echo $BRANCH_NAME | cut -d/ -f 2-5", returnStdout: true).trim()}"
                            // (pipeline) Declarative environment variable - deployment stage
                            env.GITOPS_BRANCH_ENVIRONMENT = "feat"
                            env.GITOPS_SERVICE_NAME = "${sh(script:"echo $CI_GITHUB_REPOSITORY_NAME", returnStdout: true).trim()}"
                            env.GITOPS_DOCKER_BRANCH_TAG = "${sh(script:"echo $CI_BRANCH_ENVIRONMENT", returnStdout: true).trim()}"
                            env.GITOPS_DOCKER_FEATURE_TAG = "${sh(script:"echo $CI_GITHUB_FEATURE_VERSION", returnStdout: true).trim()}"
                        }
                    }
                }
                stage('prepare-develop-environment') {
                    when {
                        expression {
                            env.BRANCH_NAME ==~ /develop/
                        }
                    }
                    steps{
                        script {
                            // (pipeline) Declarative environment variable - build stage
                            env.CI_BRANCH_ENVIRONMENT = "${sh(script:"echo $BRANCH_NAME", returnStdout: true).trim()}"
                            env.CI_GITHUB_FEATURE_VERSION = "${sh(script:"git log --merges --pretty=format:'%s' -1 | tr '[:upper:]' '[:lower:]' | grep 'feature' | cut -d/ -f3", returnStdout: true).trim()}"
                            // (pipeline) Declarative environment variable - deployment stage
                            env.GITOPS_BRANCH_ENVIRONMENT = "dev"
                            env.GITOPS_SERVICE_NAME = "${sh(script:"echo $CI_GITHUB_REPOSITORY_NAME", returnStdout: true).trim()}"
                            env.GITOPS_DOCKER_BRANCH_TAG = "${sh(script:"echo $CI_BRANCH_ENVIRONMENT", returnStdout: true).trim()}"
                        }
                    }
                }
                stage('prepare-release-environment') {
                    when {
                        expression {
                            env.BRANCH_NAME ==~ /release\/\d+\.\d+\.\d+/ // e.g: release/1.0.0
                        }
                    }
                    steps{
                        script {
                            // (pipeline) Declarative environment variable - build stage
      	                    env.CI_BRANCH_ENVIRONMENT = "${sh(script:"echo $BRANCH_NAME | cut -d/ -f1", returnStdout: true).trim()}"
      	                    env.CI_GITHUB_RELEASE_VERSION = "${sh(script:"echo $BRANCH_NAME | cut -d/ -f2", returnStdout: true).trim()}"
                            // (pipeline) Declarative environment variable - deployment stage
                            env.GITOPS_BRANCH_ENVIRONMENT = "staging"
			    env.GITOPS_BRANCH_ENVIRONMENTS= "uat"
                            env.GITOPS_SERVICE_NAME = "${sh(script:"echo $CI_GITHUB_REPOSITORY_NAME", returnStdout: true).trim()}"
                            env.GITOPS_DOCKER_BRANCH_TAG = "${sh(script:"echo $CI_BRANCH_ENVIRONMENT", returnStdout: true).trim()}"
                            env.GITOPS_DOCKER_RELEASE_TAG = "${sh(script:"echo $CI_GITHUB_RELEASE_VERSION", returnStdout: true).trim()}"
                        }
                    }
                }
                stage('prepare-master-environment') {
                    when {
                        expression {
                            env.BRANCH_NAME ==~ /master/ // e.g master
                        }
                    }
                    steps{
                        script {
                            // (pipeline) Declarative environment variable - build stage
			    env.CI_BRANCH_ENVIRONMENT = "${sh(script:"echo $BRANCH_NAME | cut -d/ -f1", returnStdout: true).trim()}"
			    env.CI_GITHUB_PROD_VERSION = "${sh(script:"git log --merges --pretty=format:'%s' -1 | tr '[:upper:]' '[:lower:]' | grep 'release' | cut -d/ -f3", returnStdout: true).trim()}"
                            // (pipeline) Declarative environment variable - deployment stage
                            env.GITOPS_BRANCH_ENVIRONMENT = "pre-production"
                            env.GITOPS_BRANCH_ENVIRONMENTS = "production"
			    env.GITOPS_SERVICE_NAME = "${sh(script:"echo $CI_GITHUB_REPOSITORY_NAME", returnStdout: true).trim()}"
                        }
                    }
                }
            }
        }
        // authen docker registry
        stage('authentication-docker-registry') {
            when {
                expression {
                    env.CI_BRANCH_ENVIRONMENT ==~ /feature|develop|release|master/
                }
            }
            steps{
                container('dind-awscli') {
                    authenticationDockerRegistry()
                }
            }
        post {
            failure {
                slackSend channel: '#test-integrate-firebase-pocflutter',
                          color: "danger",
                          message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                }
            }
        }
        // authen snyk
        stage('authentication-snyk') {
            when {
                expression {
                    env.CI_BRANCH_ENVIRONMENT ==~ /feature|develop|release|master/
                }
            }
            steps{
                container('dind-awscli') {
                    authenticationSnyk()
                }
            }
            // when dind snyk authen success, also golang as well for provides scaning dependency stage
            post {
                success {
                    script {
                        container('java') {
                            authenticationSnyk()
                        }
                    }
                }
                failure {
                    slackSend channel: '#test-integrate-firebase-pocflutter',
                              color: "danger",
                              message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                }
            }
        }
        // build static
        stage('build-static') {
            parallel {
                stage('build-static-feature') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /feature/
                        }
                    }
                    steps{
                        container('java') {
                            withCredentials([file(credentialsId: 'JK_FEAT_ENVS', variable: 'envs'),
			                     file(credentialsId: 'JK_FEAT_NGINX_CONF', variable: 'nginx_config'),
			                     file(credentialsId: 'JK_FIREBASE_CONFIG', variable: 'firebase_config')]) {
    		            // Create file env
			    sh "cat ${envs} > .env"
    		            // Create nginx config file
			    sh "cat ${nginx_config} > nginx.conf"
    		            // Create filebase config file
			    sh "cat ${firebase_config} > web/firebase-config-service.js"
			    // override static file - web/index.html
			    sh """sed -i 's:<base href\\s*=\\s*"[^"]*"\\s*>:<base href="/${GITOPS_BRANCH_ENVIRONMENT}/template-flutter-clean-arch/">:g' web/index.html"""
			    buildWebService()
			    }
                        }
                    }
                post {
                    success {
                        container('dind-awscli') {
                            sh 'docker build . --tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT} --network=host'
                        }
                    }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('build-static-develop') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /develop/
                        }
                    }
                    steps{
                        container('java') {
                            withCredentials([file(credentialsId: 'JK_DEV_ENVS', variable: 'envs'),
			                     file(credentialsId: 'JK_DEV_NGINX_CONF', variable: 'nginx_config'),
			                     file(credentialsId: 'JK_FIREBASE_CONFIG', variable: 'firebase_config')]) {
    		            // Create file env
			    sh "cat ${envs} > .env"
    		            // Create nginx config file
			    sh "cat ${nginx_config} > nginx.conf"
    		            // Create filebase config file
			    sh "cat ${firebase_config} > web/firebase-config-service.js"
			    // override static file - web/index.html
			    sh """sed -i 's:<base href\\s*=\\s*"[^"]*"\\s*>:<base href="/${GITOPS_BRANCH_ENVIRONMENT}/template-flutter-clean-arch/">:g' web/index.html"""
			    buildWebService()
			    }
                        }
                    }
                post {
                    success {
                        container('dind-awscli') {
                            sh 'docker build . --tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT} --network=host'
                        }
                    }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('build-static-release-staging') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENT ==~ /staging/
                        }
                    }
                    steps{
                        container('java') {
                            withCredentials([file(credentialsId: 'JK_STAGING_ENVS', variable: 'envs'),
			                     file(credentialsId: 'JK_STAGING_NGINX_CONF', variable: 'nginx_config'),
			                     file(credentialsId: 'JK_FIREBASE_CONFIG', variable: 'firebase_config')]) {
    		            // Create file env
			    sh "cat ${envs} > .env"
    		            // Create nginx config file
			    sh "cat ${nginx_config} > nginx.conf"
    		            // Create filebase config file
			    sh "cat ${firebase_config} > web/firebase-config-service.js"
			    // override static file - web/index.html
			    sh """sed -i 's:<base href\\s*=\\s*"[^"]*"\\s*>:<base href="/${GITOPS_BRANCH_ENVIRONMENT}/template-flutter-clean-arch/">:g' web/index.html"""
			    buildWebService()
			    }
                        }
	            }
                post {
                    success {
                        container('dind-awscli') {
                            sh 'docker build . --tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT} --network=host'
                        }
                    }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('build-static-release-uat') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENTS ==~ /uat/
                        }
                    }
                    steps{
                        container('java') {
                            withCredentials([file(credentialsId: 'JK_UAT_ENVS', variable: 'envs'),
			                     file(credentialsId: 'JK_UAT_NGINX_CONF', variable: 'nginx_config'),
			                     file(credentialsId: 'JK_FIREBASE_CONFIG', variable: 'firebase_config')]) {
			    // waiting 5 minutes for stag: build-static-release-staging - build successfully
			    sh 'sleep 300'
    		            // Create file env
			    sh "cat ${envs} > .env"
    		            // Create nginx config file
			    sh "cat ${nginx_config} > nginx.conf"
    		            // Create filebase config file
			    sh "cat ${firebase_config} > web/firebase-config-service.js"
			    // override static file - web/index.html
			    sh """sed -i 's:<base href\\s*=\\s*"[^"]*"\\s*>:<base href="/${GITOPS_BRANCH_ENVIRONMENTS}/template-flutter-clean-arch/">:g' web/index.html"""
			    buildWebService()
			    }
                        }
	            }
                post {
                    success {
                        container('dind-awscli') {
                            sh 'docker build . --tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS} --network=host'
                        }
                    }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('build-static-master-pre-production') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENT ==~ /pre-production/
                        }
                    }
                    steps{
                        container('java') {
                            withCredentials([file(credentialsId: 'JK_PRE_PRODUCTION_ENVS', variable: 'envs'),
			                     file(credentialsId: 'JK_PRE_PRODCTION_NGINX_CONF', variable: 'nginx_config'),
			                     file(credentialsId: 'JK_FIREBASE_CONFIG', variable: 'firebase_config')]) {
    		            // Create file env
			    sh "cat ${envs} > .env"
    		            // Create nginx config file
			    sh "cat ${nginx_config} > nginx.conf"
    		            // Create filebase config file
			    sh "cat ${firebase_config} > web/firebase-config-service.js"
			    // override static file - web/index.html
			    sh """sed -i 's:<base href\\s*=\\s*"[^"]*"\\s*>:<base href="/${GITOPS_BRANCH_ENVIRONMENT}/template-flutter-clean-arch/">:g' web/index.html"""
			    buildWebService()
			    }
                        }
	            }
                post {
                    success {
                        container('dind-awscli') {
                            sh 'docker build . --tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT} --network=host'
                        }
                    }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('build-static-master-production') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENTS ==~ /production/
                        }
                    }
                    steps{
                        container('java') {
                            withCredentials([file(credentialsId: 'JK_PRODUCTION_ENVS', variable: 'envs'),
			                     file(credentialsId: 'JK_PRODUCTION_NGINX_CONF', variable: 'nginx_config'),
			                     file(credentialsId: 'JK_FIREBASE_CONFIG', variable: 'firebase_config')]) {
			    // waiting 5 minutes for stag: build-static-master-pre-production - build successfully
			    sh 'sleep 300'
    		            // Create file env
			    sh "cat ${envs} > .env"
    		            // Create nginx config file
			    sh "cat ${nginx_config} > nginx.conf"
    		            // Create filebase config file
			    sh "cat ${firebase_config} > web/firebase-config-service.js"
			    // override static file - web/index.html
			    sh """sed -i 's:<base href\\s*=\\s*"[^"]*"\\s*>:<base href="/${GITOPS_BRANCH_ENVIRONMENTS}/template-flutter-clean-arch/">:g' web/index.html"""
			    buildWebService()
			    }
                        }
	            }
                post {
                    success {
                        container('dind-awscli') {
                            sh 'docker build . --tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS} --network=host'
                        }
                    }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
	    }
	}
        // thrid party dependency analysis
        stage('thrid-party-dependency-analysis') {
            when {
                expression {
                    env.CI_BRANCH_ENVIRONMENT ==~ /feature|develop|release|master/
                }
            }
            steps{
                container('dind-awscli') {
                    echo 'snyk dependency scaning..'
                    // thirdPartyDependencyAnalysis()
                }
            }
            post {
                failure {
                    slackSend channel: '#test-integrate-firebase-pocflutter',
                              color: "danger",
                              message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                }
            }
        }
        // trigger github workflows
        stage('trigger-github-workflows') {
            parallel {
                stage('trigger-github-workflows') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /feature|develop|release|master/
                        }
                    }
                    steps{
		        sh "echo 'android\nios\n' > devices.txt"
                        sh '''#!/bin/bash
			      set -x
			      github_access_token=$(echo ${CI_GITHUB_ACCESS_TOKEN})
			      github_organization=$(echo ${CI_GITHUB_ORGANIZATION})
			      github_repository=$(echo ${CI_GITHUB_REPOSITORY_NAME})
			      github_branch=$(echo ${BRANCH_NAME})
			      environment=$(echo ${CI_BRANCH_ENVIRONMENT})
			      gitops_environment=$(echo ${GITOPS_BRANCH_ENVIRONMENT})
			      device=(cat devices.txt)
			      while read -r device; do
                                curl -X POST \
                                -H "Authorization: token ${github_access_token}" \
                                -H "Accept: application/vnd.github.v3+json" \
                                https://api.github.com/repos/${github_organization}/${github_repository}/actions/workflows/fastlane-${device}.yaml/dispatches \
				-d '{"ref":"'"${github_branch}"'", "inputs": { "apiUrl": "https://sandbox.hugeman.co/'"${gitops_environment}"'/template-golang-clean-arch/api/restful/v1", "ssrUrl": "https://sandbox.hugeman.co/'"${gitops_environment}"'/template-golang-clean-arch/api/sse/v1", "grpcWebScheme": "https", "grpcWebDomain": "grpc-proxy.hugeman.co:/'"${gitops_environment}"'/template-golang-clean-arch/grpc", "grpcWebPort": "443", "grpcMobileDomain": "grpc.hugeman.co:80", "grpcMobilePort": "80", "websocketUrl": "wss://sandbox.hugeman.co/'"${gitops_environment}"'/template-golang-clean-arch/ws/v1/tasks", "branch": "'"${environment}"'" } }'
			      done <  <(cat devices.txt)
			'''
                    }
                post {
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('trigger-github-workflows-bugfix') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /bugfix/
                        }
                    }
                    steps{
		        // androd
                        sh (""" curl \
                        -H "Authorization: token ${CI_GITHUB_ACCESS_TOKEN}" \
                        -X POST \
			-H "Accept: application/vnd.github.v3+json" \
			https://api.github.com/repos/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_REPOSITORY_NAME}/actions/workflows/fastlane-android.yaml/dispatches \
			-d '{"ref":"${env.BRANCH_NAME}", "inputs": { "apiUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/v1", "ssrUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/sse/v1", "grpcWebScheme": "https", "grpcWebDomain": "devsecops.hugeman.co", "grpcWebPort": "443", "grpcMobileDomain": "devsecops.hugeman.co", "grpcMobilePort": "443", "branch": "${CI_BRANCH_ENVIRONMENT}" }  }'""")
			sleep 15
		        // ios
                        sh (""" curl \
                        -H "Authorization: token ${CI_GITHUB_ACCESS_TOKEN}" \
                        -X POST \
			-H "Accept: application/vnd.github.v3+json" \
			https://api.github.com/repos/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_REPOSITORY_NAME}/actions/workflows/fastlane-ios.yaml/dispatches \
			-d '{"ref":"${env.BRANCH_NAME}", "inputs": { "apiUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/v1", "ssrUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/sse/v1", "grpcWebScheme": "https", "grpcWebDomain": "devsecops.hugeman.co", "grpcWebPort": "443", "grpcMobileDomain": "devsecops.hugeman.co", "grpcMobilePort": "443", "branch": "${CI_BRANCH_ENVIRONMENT}" }  }'""")
                    }
                post {
                    failure {
                        slackSend channel: '#test-template-golang-clean-arch', 
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('trigger-github-workflows-hotfix') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /hotfix/
                        }
                    }
                    steps{
		        // androd
                        sh (""" curl \
                        -H "Authorization: token ${CI_GITHUB_ACCESS_TOKEN}" \
                        -X POST \
			-H "Accept: application/vnd.github.v3+json" \
			https://api.github.com/repos/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_REPOSITORY_NAME}/actions/workflows/fastlane-android.yaml/dispatches \
			-d '{"ref":"${env.BRANCH_NAME}", "inputs": { "apiUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/v1", "ssrUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/sse/v1", "grpcWebScheme": "https", "grpcWebDomain": "devsecops.hugeman.co", "grpcWebPort": "443", "grpcMobileDomain": "devsecops.hugeman.co", "grpcMobilePort": "443", "branch": "${CI_BRANCH_ENVIRONMENT}" }  }'""")
			sleep 15
		        // ios
                        sh (""" curl \
                        -H "Authorization: token ${CI_GITHUB_ACCESS_TOKEN}" \
                        -X POST \
			-H "Accept: application/vnd.github.v3+json" \
			https://api.github.com/repos/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_REPOSITORY_NAME}/actions/workflows/fastlane-ios.yaml/dispatches \
			-d '{"ref":"${env.BRANCH_NAME}", "inputs": { "apiUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/v1", "ssrUrl": "https://sandbox.hugeman.co/feat/template-golang-clean-arch/api/sse/v1", "grpcWebScheme": "https", "grpcWebDomain": "devsecops.hugeman.co", "grpcWebPort": "443", "grpcMobileDomain": "devsecops.hugeman.co", "grpcMobilePort": "443", "branch": "${CI_BRANCH_ENVIRONMENT}" }  }'""")
                    }
                post {
                    failure {
                        slackSend channel: '#test-template-golang-clean-arch', 
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
            }
        }
        // image security analysis
        stage('image-security-analysis') {
            when {
                expression {
		    env.CI_BRANCH_ENVIRONMENT ==~ /feature|develop|release|master/
                }
            }
            steps{
                container('dind-awscli') {
     	            echo "image-security-analysis-feature.."
		    // imageSecurityAnalysis()
                }
            }
            post {
                failure {
                    slackSend channel: '#test-integrate-firebase-pocflutter',
                              color: "danger",
                              message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                }
            }
        }
        // push dockerize to aws ecr
        stage('push-dockerize-to-aws-ecr') {
            parallel {
                stage('push-dockerize-to-aws-ecr-feature') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /feature/
                        }
                    }
                    steps{
                        container('dind-awscli') {
			    pushDockerizeToAwsEcr()
			    sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${CI_GITHUB_FEATURE_VERSION}-${BUILD_NUMBER}'
			    sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${CI_GITHUB_FEATURE_VERSION}-${BUILD_NUMBER}'
                        }
                    }
                post {
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('push-dockerize-to-aws-ecr-develop') {
                    when {
                        expression {
                            env.BRANCH_NAME ==~ /develop/
                        }
                    }
                    steps{
                        container('dind-awscli') {
			    pushDockerizeToAwsEcr()
                        }
                    }
                post {
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('push-dockerize-to-aws-ecr-release') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /release/
                        }
                    }
                    steps{
                        container('dind-awscli') {
			    // tag release-staging => release-staging-0.0.0
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_RELEASE_VERSION}'
                            // tag release-uat => release-uat-0.0.0
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_RELEASE_VERSION}'
                            // push release-staging-0.0.0
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_RELEASE_VERSION}'
                            // push release-uat-0.0.0
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_RELEASE_VERSION}'
                            // tag release-staging-0.0.0 => release-staging-0.0.0-n
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_RELEASE_VERSION} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_RELEASE_VERSION}-${BUILD_NUMBER}'
                            // tag release-uat-0.0.0 => release-uat-0.0.0-n
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_RELEASE_VERSION} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_RELEASE_VERSION}-${BUILD_NUMBER}'
                            // push release-staging-0.0.0 => release-staging-0.0.0-n
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_RELEASE_VERSION}-${BUILD_NUMBER}'
                            // push release-uat-0.0.0 => release-uat-0.0.0-n
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_RELEASE_VERSION}-${BUILD_NUMBER}'
                        }
                    }
                post {
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('push-dockerize-to-aws-ecr-master') {
                    when {
                        expression {
                            env.CI_BRANCH_ENVIRONMENT ==~ /master/
                        }
                    }
                    steps{
                        container('dind-awscli') {
			    // tag release-pre-production => pre-production-0.0.0
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENT} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_PROD_VERSION}'
                            // tag release-production => production-0.0.0
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${CI_BRANCH_ENVIRONMENT}-${GITOPS_BRANCH_ENVIRONMENTS} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_PROD_VERSION}'
                            // push pre-prodution-0.0.0
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_PROD_VERSION}'
                            // push procution-0.0.0
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_PROD_VERSION}'
                            // tag pre-production-0.0.0 => pre-production-0.0.0-n
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_PROD_VERSION} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}'
                            // tag production-0.0.0 => production-0.0.0-n
                            sh 'docker tag ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_PROD_VERSION} ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}'
                            // push pre-production-0.0.0 => pre-production-0.0.0-n
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}'
                            // push production-0.0.0 => production-0.0.0-n
                            sh 'docker push ${CI_DOCKER_REGISTRY_NAME}/${CI_GITHUB_REPOSITORY_NAME}:${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}'
                        }
                    }
                post {
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
            }
        }
        // deployment application
        stage('deployment') {
            parallel {
                stage('deployment-feat') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENT ==~ /feat/
                        }
                    }
                    steps{
                        sh "git clone https://${CI_GITHUB_ACCESS_TOKEN}@github.com/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_GITOPS_REPO}.git --branch ${GITOPS_BRANCH_ENVIRONMENT}"
                        sh "git config --global user.email \"${CI_GITHUB_EMAIL}\""
                        sh "git config --global user.name \"${CI_GITHUB_USER}\""
                        sh ("""cd ${CI_GITHUB_GITOPS_REPO} && \
                        sed -i 's/tag: '${GITOPS_DOCKER_BRANCH_TAG}-.*'/tag: '${GITOPS_DOCKER_BRANCH_TAG}-${GITOPS_DOCKER_FEATURE_TAG}-${BUILD_NUMBER}'/g' application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git add application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git diff-index --quiet HEAD || git commit --message \"[Bot] Updated application helm values: ${GITOPS_DOCKER_BRANCH_TAG}-${GITOPS_DOCKER_FEATURE_TAG}-${BUILD_NUMBER}\" && \
                        git push --set-upstream origin ${GITOPS_BRANCH_ENVIRONMENT}""")
                    }
                post {
                    success {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
			          color: "good",
                                  message: "*Jenkins pipelines status*: success\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('deployment-dev') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENT ==~ /dev/
                        }
                    }
                    steps{
                        sh "git clone https://${CI_GITHUB_ACCESS_TOKEN}@github.com/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_GITOPS_REPO}.git --branch ${GITOPS_BRANCH_ENVIRONMENT}"
                        sh "git config --global user.email \"${CI_GITHUB_EMAIL}\""
                        sh "git config --global user.name \"${CI_GITHUB_USER}\""
                        sh ("""cd ${CI_GITHUB_GITOPS_REPO} && \
                        sed -i 's/tag: '${GITOPS_DOCKER_BRANCH_TAG}-.*'/tag: '${GITOPS_DOCKER_BRANCH_TAG}-${BUILD_NUMBER}'/g' application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git add application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git diff-index --quiet HEAD || git commit --message \"[Bot] Updated application helm values: ${GITOPS_DOCKER_BRANCH_TAG}-${BUILD_NUMBER}\" && \
                        git push --set-upstream origin ${GITOPS_BRANCH_ENVIRONMENT}""")
                    }
                post {
                    success {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
			          color: "good",
                                  message: "*Jenkins pipelines status*: success\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('deployment-staging-n-uat') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENT ==~ /staging/
                        }
                    }
                    steps{
                        sh "git clone https://${CI_GITHUB_ACCESS_TOKEN}@github.com/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_GITOPS_REPO}.git --branch ${GITOPS_BRANCH_ENVIRONMENT}"
                        sh "git config --global user.email \"${CI_GITHUB_EMAIL}\""
                        sh "git config --global user.name \"${CI_GITHUB_USER}\""
                        sh ("""cd ${CI_GITHUB_GITOPS_REPO} && \
                        sed -i 's/tag: .*/tag: '${GITOPS_DOCKER_BRANCH_TAG}-${GITOPS_BRANCH_ENVIRONMENT}-${GITOPS_DOCKER_RELEASE_TAG}-${BUILD_NUMBER}'/g' application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git add application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git diff-index --quiet HEAD || git commit --message \"[Bot] Updated application helm values: ${GITOPS_DOCKER_BRANCH_TAG}-${GITOPS_BRANCH_ENVIRONMENT}-${GITOPS_DOCKER_RELEASE_TAG}-${BUILD_NUMBER}\" && \
                        git push --set-upstream origin ${GITOPS_BRANCH_ENVIRONMENT}""")
                    }
                post {
                    success {
                        script {
                            // deployment second environment
                            sh ("""cd ${CI_GITHUB_GITOPS_REPO} && \
			    git checkout ${GITOPS_BRANCH_ENVIRONMENTS} && \
                            sed -i 's/tag: .*/tag: '${GITOPS_DOCKER_BRANCH_TAG}-${GITOPS_BRANCH_ENVIRONMENTS}-${GITOPS_DOCKER_RELEASE_TAG}-${BUILD_NUMBER}'/g' application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                            git add application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                            git diff-index --quiet HEAD || git commit --message \"[Bot] Updated application helm values: ${GITOPS_DOCKER_BRANCH_TAG}-${GITOPS_BRANCH_ENVIRONMENTS}-${GITOPS_DOCKER_RELEASE_TAG}-${BUILD_NUMBER}\" && \
                            git push --set-upstream origin ${GITOPS_BRANCH_ENVIRONMENTS}""")
                        }
                        slackSend channel: '#test-integrate-firebase-pocflutter',
			          color: "good",
                                  message: "*Jenkins pipelines status*: success\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
                stage('deployment-pre-production-n-production') {
                    when {
                        expression {
                            env.GITOPS_BRANCH_ENVIRONMENT ==~ /pre-production/
                        }
                    }
                    steps{
                        sh "git clone https://${CI_GITHUB_ACCESS_TOKEN}@github.com/${CI_GITHUB_ORGANIZATION}/${CI_GITHUB_GITOPS_REPO}.git --branch ${GITOPS_BRANCH_ENVIRONMENT}"
                        sh "git config --global user.email \"${CI_GITHUB_EMAIL}\""
                        sh "git config --global user.name \"${CI_GITHUB_USER}\""
                        sh ("""cd ${CI_GITHUB_GITOPS_REPO} && \
                        sed -i 's/tag: .*/tag: '${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}'/g' application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git add application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                        git diff-index --quiet HEAD || git commit --message \"[Bot] Updated application helm values: ${GITOPS_BRANCH_ENVIRONMENT}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}\" && \
                        git push --set-upstream origin ${GITOPS_BRANCH_ENVIRONMENT}""")
                    }
                post {
                    success {
                        script {
                            // deployment second environment
                            sh ("""cd ${CI_GITHUB_GITOPS_REPO} && \
			    git checkout ${GITOPS_BRANCH_ENVIRONMENTS} && \
                            sed -i 's/tag: .*/tag: '${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}'/g' application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                            git add application/${GITOPS_SERVICE_NAME}/application/helm/values.yaml && \
                            git diff-index --quiet HEAD || git commit --message \"[Bot] Updated application helm values: ${GITOPS_BRANCH_ENVIRONMENTS}-${CI_GITHUB_PROD_VERSION}-${BUILD_NUMBER}\" && \
                            git push --set-upstream origin ${GITOPS_BRANCH_ENVIRONMENTS}""")
                        }
                        slackSend channel: '#test-integrate-firebase-pocflutter',
			          color: "good",
                                  message: "*Jenkins pipelines status*: success\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    failure {
                        slackSend channel: '#test-integrate-firebase-pocflutter',
                                  color: "danger",
                                  message: "*Jenkins pipelines status*: failure\n *Branch*: ${env.BRANCH_NAME}\n *Commit:* ${env.GIT_COMMIT}\n *Stage* ${env.STAGE_NAME}\n *Workflow URL:* ${env.BUILD_URL}"
                        }
                    }
                }
            }
        }
    }
}
