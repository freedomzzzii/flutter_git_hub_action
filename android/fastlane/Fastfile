default_platform(:android)

fastlane_require 'dotenv'

before_all do
  Dotenv.overload '../../.env-cicd'
end

platform:android do
    # branch: all branch
    desc "Test android in Firebase test lab"
    lane:test_lab do
        sh("../gradlew app:assembleAndroidTest --settings-file=../settings.gradle")
        sh("../gradlew app:assembleDebug --settings-file=../settings.gradle -Ptarget=integration_test/main_integration_test.dart")
      
        sh("gcloud firebase test android run --type instrumentation --app ../../build/app/outputs/apk/debug/app-debug.apk --test ../../build/app/outputs/apk/androidTest/debug/app-debug-androidTest.apk --device model=Pixel2,version=28,locale=pl,orientation=portrait")
    end

    # run this lane before deploy to firebase app distribute
    desc "Build file .apk for deploy firebase app distribute"
    lane:build_file_apk do
        sh("flutter build apk --release")
    end

    desc "Run mobSF (upload file and scan file)"
    lane:mobSF do
        sh("export MOBSF_URL=#{ENV["MOBSF_URL"]}; export MOBSF_API_KEY=#{ENV["MOBSF_API_KEY"]}; export INPUT_FILE_NAME='../../build/app/outputs/apk/release/app-release.apk'; bash ../../tool/mobsf-automation.sh")
    end

    # run this lane before deploy to play store
    desc "Build file .aab for deploy play store"
    lane:build_file_appbundle do
        sh("flutter build appbundle --release")
    end

    # branches: feature, develop, bugfix, hotfix, release
    desc "Deploy a beta version to the Firebase App Distribute for Developer testing"
    lane:app_distribution_group_developer do

        firebase_app_distribution(
            app: ENV["FASTLANE_FIREBASE_APP_DISTRIBUTE_ID_ANDROID"],
            groups: "developer",
            apk_path: "../build/app/outputs/apk/release/app-release.apk"
        )
    end

    # branches: feature, develop, bugfix, hotfix, release, master(pre-prod)[tag]
    desc "Deploy a beta version to the Firebase App Distribute for QA testing"
    lane:app_distribution_group_qa do
        firebase_app_distribution(
            app: ENV["FASTLANE_FIREBASE_APP_DISTRIBUTE_ID_ANDROID"],
            groups: "qa",
            apk_path: "../build/app/outputs/apk/release/app-release.apk"
       )

        slack(
            message: "Deploy a beta version to the Firebase App Distribute for QA testing is success",
            channel: ENV["FASTLANE_SLACK_CHANNEL"],
            slack_url: ENV["FASTLANE_SLACK_WEB_HOOK"],
            default_payloads: ["lane", "test_result", "git_branch", "git_author"]
        )
    end

    # branch: release
    desc "Deploy a beta version to the Firebase App Distribute for User testing"
    lane:app_distribution_group_user do
        firebase_app_distribution(
            app: ENV["FASTLANE_FIREBASE_APP_DISTRIBUTE_ID_ANDROID"],
            groups: "user",
            apk_path: "../build/app/outputs/apk/release/app-release.apk"
        )
    end

    # tag: master
    desc "Deploy a beta version to the Play store"
    lane:beta do
        validate_play_store_json_key(
            json_key: '../play-store-credentials.json'
        )

        # Release status (used when uploading new apks/aabs)
        # see more in http://docs.fastlane.tools/actions/upload_to_play_store/#upload_to_play_store
        upload_to_play_store(
            track: 'beta',
            aab_paths:"../build/app/outputs/bundle/release/app-release.aab",
            release_status: 'draft',
            json_key: '../play-store-credentials.json',
            package_name: ENV["APP_BUNDLE_ID"],
            version_code: ENV["BUILD_NUMBER"],
        )
    end

    error do |lane, exception, options|
        # trigger jenkins
    end
end
